#include<iostream>
#include<Eigen/Dense>
#include<string>
#include<vector>
#include<stdlib.h>
#include "system.h"
#include "analysis.h"
#include "coshfunc.h"
#include "emulator.h"
#include "mcmc.h"

int main(int argc, char* argv[]){
  //Check that usage is proper: enter the model output to use
  if(argc != 3)
    {
      printf("Usage: ./main start end\n");
      return 1;
    }
  int action=1; //1 = mcmc, 2 = test emulator, 3 = test emulator

  /*************************************
   *    Write Parameters files        *
  *************************************/
  std::string 
    infoldername="model_output",                     //infoldername = model BF location
    outfoldername="stat_output",                     //outfoldername = write destination
    writefilename="parameters.dat",                  //writefilename = paramfile name, should default to parameters.dat
    rangename=infoldername+"/parameter_priors.dat",    //rangename = rangefile for parameters and paramnames to LCHsample for model run
    infilename=outfoldername+"/moments_parameters.dat", //output parameters used for model runs
    delimiter=" ",                                   //delimiter for writing and reading files
    gabname=outfoldername+"/gabfunctions.dat";          //write prior gab functions, in order eta, uu0, ud0, us0, ss0, uu1, ud1, ...

  //start, finish for model runs to use
  int
    start=atoi(argv[1]),
    finish=atoi(argv[2]),
    ab=4;

  Eigen::MatrixXd Parameters;

  WriteParameterFiles(rangename, infoldername, writefilename, delimiter,
		      start, finish, ab, 
		      Parameters);
  WriteFile(infilename,Parameters,delimiter);

  /*************************************
   *    Construct gab functions       *
  *************************************/
  WriteGABFunctions(gabname,Parameters,delimiter,ab);

  /*************************************
   *   Run Model for output           *
  *************************************/
  //Run Scott's program
  //std::string cmd = "./run.sh "+std::to_string(start)+" "+std::to_string(finish);
  //std::cout << cmd << std::endl;
  //system(cmd.c_string());
  

  /*************************************
   *   Conduct model analysis         *
  *************************************/
  Eigen::MatrixXd 
    ModelZ,
    ExpZ;

  ConductModelAnalysis(infoldername, outfoldername, delimiter, start, finish, ModelZ, ExpZ);

  /*************************************
   *   Plot ModelZ w/ Params          *
  *************************************/
  //for(int i=ab-1;i>-1;i--)
  //  {
  //    RemoveColumn(Parameters,1+i*3);
  //  }
  int 
    parameters=Parameters.cols(),
    observables=ModelZ.cols();
  Eigen::MatrixXd 
    plot(finish-start,parameters+observables);
  Eigen::MatrixXd MinMax, ScaledParam;
  ScaleMatrixColumnsUniform(Parameters,MinMax,ScaledParam);
  plot.block(0,parameters,finish-start,observables) = ModelZ;

  plot.block(0,0,finish-start,parameters) = Parameters;
  WriteFile(outfoldername+"/trainplot.dat",plot," ");
  plot.block(0,0,finish-start,parameters) = ScaledParam;
  WriteFile(outfoldername+"/scaledtrainplot.dat",plot," ");
  WriteFile(outfoldername+"/scaledmoments_parameters.dat",ScaledParam," ");

  /*************************************
   *   Conduct MCMC Analysis          *
  *************************************/
  if(action==1)
    {
      int 
	test=finish-start;
      double
	fraction=1.0/250.0;
      std::vector<std::string> 
	paramNames;
  Eigen::MatrixXd 
    Hyperparameters,
    outMatrix(test,parameters+observables),
    range,
    Beta;
  Eigen::VectorXd
    Width;
  
  //Load Hyperparameters
  //LoadFile("hyperparameters.dat",Hyperparameters," ");
  ConstructHyperparameters(ModelZ,Hyperparameters);
  WriteFile(outfoldername+"/hyperparameters.dat",Hyperparameters,delimiter);
  //Load Range File
  LoadParamFile(rangename,paramNames,range,delimiter);

  //for(int i=ab-1;i>-1;i--)
  //  {
  //    RemoveRow(range,i*3+1);
  //    std::cout << i*3+1 << std::endl;
  //  }

  //Create Widths
  ConstructWidths(Width,range,parameters,fraction);

  linearRegressionLeastSquares(ModelZ,ScaledParam,Beta);
  WriteFile(outfoldername+"/scaledbeta.dat",Beta," ");

  int row=5;
  ExpZ = ModelZ.row(row);
  std::cout << row << " row: " << ScaledParam.row(row) << " " << ExpZ << std::endl;
  
  Eigen::MatrixXd Goal = Eigen::MatrixXd::Zero(1,parameters+observables);
  Goal.block(0,0,1,parameters) = Parameters.row(row);
  Goal.block(0,parameters,1,observables) = ExpZ;
  WriteFile(outfoldername+"/target.dat",Goal,delimiter);
  Goal.block(0,0,1,parameters) = ScaledParam.row(row);
  WriteFile(outfoldername+"/scaledtarget.dat",Goal,delimiter);

  emulator emulation(ScaledParam, Hyperparameters, Beta);
  bool regression=false;
  MCMC mcmc(ExpZ,range,Width,regression);
  mcmc.setPosition();
  int NSamples=100000,
    samples = finish - start;

  Eigen::MatrixXd History;
  printf("Step width fraction: %f\n",fraction);
  mcmc.Run(NSamples, History, emulation, ModelZ, MinMax);
  Eigen::MatrixXd 
    trace = History.block(0,0,NSamples,parameters),
    ntrace,
    posterior;

  std::string posteriorname = outfoldername+"/scaledposterior.dat";
  WriteFile(outfoldername+"/minmax.dat",MinMax,delimiter);

  Extract5(ntrace,trace);
  WriteCSVFile(outfoldername+"/scaledmcmctrace.csv",paramNames,ntrace,",");

  ExtractOnly20(posterior,ntrace);
  printf("Writing posterior.dat files...\n");  
  WriteFile(posteriorname,posterior,delimiter);
  for(int i=0,count=posterior.rows();i<count;i++)
    {
      for(int j=0;j<parameters;j++)
	{
	  posterior(i,j) = (posterior(i,j)*(MinMax(j,1) - MinMax(j,0)) + MinMax(j,0));
	}
    }
  for(int i=0,count=ntrace.rows();i<count;i++)
    {
      for(int j=0;j<parameters;j++)
	{
	  ntrace(i,j) = (ntrace(i,j)*(MinMax(j,1) - MinMax(j,0)) + MinMax(j,0));
	}
    }
  /*
  parameters += 4;
  Eigen::MatrixXd
    fullposterior = Eigen::MatrixXd::Zero(posterior.rows(),parameters),
    fullntrace = Eigen::MatrixXd::Zero(ntrace.rows(),parameters);
  int nmax=1;
  CCosh dist(5);
  for(int i=0;i<posterior.rows();i++){
    for(int j=0;j<ab;j++){
      fullposterior(i,j*(nmax+2)) = posterior(i,j*(nmax+2));
      fullposterior(i,j*(nmax+2)+2) = posterior(i,j*(nmax+2)+2);
      fullposterior(i,j*(nmax+2)+1) = 1.0/fullposterior(i,j*(nmax+2));
      for(int k=1;k<nmax+1;k++){
	fullposterior(i,j*(nmax+2)+1) -= fullposterior(i,j*(nmax+2)+k+1)*dist.Z(k);
      }
      fullposterior(i,j*(nmax+2)+1) /= (dist.Z(0));
    }
  }      
  */
  posteriorname = outfoldername + "/posterior.dat";
  ExtractOnly20(posterior,ntrace);
  WriteFile(posteriorname,posterior,delimiter);

  gabname = outfoldername + "/posteriorgabfunctions.dat";
  WriteGABFunctions(gabname,posterior,delimiter,ab);

  WriteCSVFile(outfoldername+"/mcmctrace.csv",paramNames,ntrace,",");
  
  Eigen::VectorXd
    avg = Eigen::VectorXd::Zero(observables);
  AverageColumns(avg,ntrace);
  Eigen::MatrixXd
    Avg = Eigen::MatrixXd::Zero(1,observables);
  Avg.row(0) = avg;
  WriteFile(outfoldername+"/mcmcmean.dat",Avg,delimiter);
}


  /*************************************
   *   Conduct Fit Analysis           *
  *************************************/
  if(action==2)
    {

  int 
    test=finish-start;
  std::vector<std::string> 
    paramNames;
  Eigen::MatrixXd 
    Hyperparameters,
    range,
    Beta,
    testY,
    print = Eigen::MatrixXd::Zero(finish-start, parameters+observables*4);

  Eigen::VectorXd Width(parameters);

  LoadParamFile(rangename,paramNames,range,delimiter);
  //printf("Scaling range.\n");

  //Create & Write Beta matrix
  int rows = finish-start;

  for(int row=0;row<rows;row++){
    //Eigen::MatrixXd testX = Parameters.row(row);
    Eigen::MatrixXd testX = ScaledParam.row(row);

    //Eigen::MatrixXd testY_ = ModelZ.row(row),
    // PM = Parameters,
    // MZ = ModelZ;
    Eigen::MatrixXd testY_ = ModelZ.block(row,0,1,observables),
      //PM = Parameters,
      PM = ScaledParam,
      MZ = ModelZ;

    RemoveRow(PM,row);
    RemoveRow(MZ,row);
    //Load Hyperparameters
    ConstructHyperparameters(MZ,Hyperparameters);

    linearRegressionLeastSquares(MZ,PM,Beta);

    std::cout << std::endl;
    std::cout << "row " << row << std::endl;
    std::cout << "testX : " << testX << std::endl;
    std::cout << "ModelY: " << testY_ << std::endl;
    print.block(row,0,1,parameters) = testX;

    Eigen::MatrixXd Fit;
    emulator emulation(PM, Hyperparameters, Beta);
    emulation.Emulate(testX, MZ, testY);
    std::cout << "RtestY:" << testY << std::endl;
    ComputeFit(testY_,testY,Fit);
    std::cout << "Fit   :" << Fit << std::endl;
    print.block(row,parameters,1,observables) = testY;
    print.block(row,parameters+observables,1,observables) = Fit.block(0,1,1,observables);    

    emulation.Emulate_NR(testX, MZ, testY);
    std::cout << "testY :" << testY << std::endl;
    ComputeFit(testY_,testY,Fit);
    std::cout << "Fit   :" << Fit << std::endl << std::endl;
    print.block(row,parameters+2*observables,1,observables) = testY;
    print.block(row,parameters+3*observables,1,observables) = Fit.block(0,1,1,observables);    
  }
  WriteFile(infoldername+"/fit.dat",print,delimiter);
    }
  Eigen::MatrixXd
    print = Eigen::MatrixXd::Zero(200,parameters+observables);

  if(action==3)
    {
      for(int i=ab-1;i>-1;i--)
	{
	  RemoveColumn(ScaledParam,1+i*3);
	}
      parameters = ScaledParam.cols();
      for(int i=0;i<200;i++){
	int 
	  test=finish-start;
	std::vector<std::string> 
	  paramNames;
	Eigen::MatrixXd 
	  Hyperparameters,
	  outMatrix(test,parameters+observables),
	  Beta;
	Eigen::VectorXd
	  Width;
  
      //Load Hyperparameters
      //LoadFile("hyperparameters.dat",Hyperparameters," ");
      int row=i,
	samples = ModelZ.rows();
      Eigen::MatrixXd
	testX = ScaledParam.row(row),
	Fit,

	testY = ModelZ.row(row),
	trainY = ModelZ,
	trainX= ScaledParam;

      RemoveRow(trainX,row);
      RemoveRow(trainY,row);

      ConstructHyperparameters(trainY,Hyperparameters);  
      linearRegressionLeastSquares(trainY,trainX,Beta);

      emulator emulation(trainX, Hyperparameters, Beta);
      emulation.Emulate(testX,trainY,outMatrix);

      print.block(row,0,1,parameters) = testX;
      print.block(row,parameters,1,observables) = outMatrix;
      std::cout << i << ":" << std::endl;
      std::cout << testY << std::endl;
      std::cout << outMatrix << std::endl;

      }  
  WriteFile("outMatrix.dat",print," ");
    }


  return 0;
}
